# RATE RESET 2020

This program is designed to consume csv index files generated by Docusign Retrieve and, based on the information provided, generate the .csv file for a Symitar PowerOn and also Synergy formatted XML index files. 

This is a batch process that should be run daily. Typically we run it after branches close but scheduling should be whatever works best for your organization. 

## Requirements

### Any system capable of running PHP in 'CLI' mode. (No need to configure a web server. whew!)
 * To get the installer for windows use the link https://windows.php.net/download/
 * Mac or Linux, https://www.php.net/manual/en/install.php

_If you are feeling brave enough to tinker with PHP as a language, I strongly recommend https://www.php.net/manual/en/_

### A Place to Call Home
 * A directory to hold your data and run your scripts in. Here is the tree required. 
 
 _values wrapped in {{}} indicate it is a setting in the config file. (don't worry, we'll get there)_

A the directory tree should look something like this..
```
  - {{basedir}}        # basedir is the path where all RateReset data and files reside.
    - {{typedir}}      # typedir is the directory where RateReset files for the product type is held
    - archive          # archive is automatically generated by the script. 
```

### Product Type

Our solution is based on breaking down each RateReset offering into a separate type. What does this mean? 

Each type will have the following:
* a Docusign Retrieve sub-account. This will help prevent mixing of data accross product types
* a Docusign Retrieve generated index file
* a separate directory for processing RateReset files
* a separate config file adjusted to needs specific to the product type

### The Docusign Retrieve Index File

This is a CSV formatted file that is generated by Docusign Retrieve. 

This file should include all data that is required to perform both of the following functions:
* Any details specific to the document that would be required to file them in Synergy. 
* Any information required to peform required updates to the account in Symitar.

This file should always include a header row with the names of each field in the file. For example:

```
"Envelope Id","Payment","Interest Rate","Maturity Date","Amount Advanced","Payment Count","BorrowerFirstName","BorrowerLastName","SSN","Loan Number","Date of Last Modification","Loan Suffix","Cabinet","Type"
"6fce2137-ee37-4193-993f-a5d621ef3ece","$225.05","11.65","8/22/2025","$2,000.00","12","JEFF","LEWBOWSKI","","132134","2/25/2021","02","LOANS","LOANFLEX MODIFICATION AGREEMENT"
```

Wow..that's a lot.. we'll get back to how to deal with this in a moment


### The Config File

This is where all the magic happens. It is a json formatted file so there are some rules to editing these. _see https://www.json.org/json-en.html_

You'll need to create as separate config file for each product type. It is best practice to name each config file to match the product. For example, "auto_reset_config.json" would be the config for resetting auto loans. 


## Setup

### PHP 

_Windows_ There isn't an installer for PHP. It just downloads a zip file that expands into a directory of executables and supporting files. Find a place to you want to locate the PHP folder and then add that directory path to you $PATH environment variable.

_MacOS or Linux_ Both platforms have package managers available to handle this.

You'll know it's setup correctly when you can open a PowerShell or CMD prompt and do the following:
```
C:\Users\someuser>php --version
```

Output should be (dates and versions may vary):
```
PHP 7.4.15 (cli) (built: Feb  2 2021 20:47:36) ( NTS Visual C++ 2017 x64 )
Copyright (c) The PHP Group
Zend Engine v3.4.0, Copyright (c) Zend Technologies
```

### Docusign Retrieve

Probably should explain how this works. 

### Config Files

#### Sample Config File

Ok, so this is what a config looks like...

```json
{
  "description": "home equity open end payment",
  "basedir": "/var/opt/shared/RateReset/",
  "typedir": "home_equity_openend",
  "docusign_infile": {
    "description": "file downloaded from docusign retrieve",
    "filename": "index.csv",
    "infile_fields": [
      "Envelope Id",
      "First Name",
      "Last Name",
      "SSN",
      "Account Number",
      "Loan ID",
      "New Due Date",
      "Deferral Request Months",
      "Deferral Requested Date",
      "Cabinet",
      "Type"
    ]
  },
  "sym_postfile": {
    "description": "fields to be included in Symitar datafile, must be from infile_fields",
    "filename": "RATERESET.HE.OE.DEFER.DAT",
    "header": false,
    "postfile_fields": [
      "Account Number",
      "Loan ID",
      "New Due Date",
      "Deferral Request Months",
      "Deferral Requested Date"
    ]
  },
  "SynergyImportSettings": {
    "description": "Synergy indexing fields can be fixed or pulled from infile_fields using template notation",
    "ftp_files": false,
    "import_host": "synergyhost",
    "import_user": "nobody",
    "import_pass": "password1",
    "import_dir": "/optical/import/dir",
    "file_room": "SomeCU",
    "institution": "999",
    "deleteFiles": true,
    "cabinet": "{{Cabinet}}",
    "type": "{{Type}}",
    "docname": "{{Type}}",
    "indexes": [
      {
        "name": "ACCOUNT NUMBER",
        "value": "{{Account Number}}"
      },
      {
        "name": "LOAN ID",
        "value": "{{Loan ID}}"
      },
      {
        "name": "NAME",
        "value": "{{First Name}} {{Last Name}}"
      },
      {
        "name": "TAX ID",
        "value": "{{SSN}}"
      },
      {
        "name": "DOC DATE",
        "value": "{{Deferral Requested Date}}"
      },
      {
        "name": "INDEX DATE",
        "value": "{{_today_}}"
      }
    ],
    "file": "{{Envelope Id}}"
  }
}
```

#### Config File Settings Defined

   ___note__: All paths can be absolute or relative to your present working directory (pwd). File paths in PHP should have all directories separated by a forward slash (/) regarless of platform its running on. PHP will translate to it's environment._

  __basedir__ : The base directory where all RateReset files and folders reside

  __typedir__ : Subdirectory of __basedir__, all files related to a product offering reside here

  __docusign_infile__ : Details about the index file generated by Docusign Retrieve

  * __filename__ : Name of the index file generated by Docusign Retrieve

  * __infile_fields__ : List of fields (columns) in the index file generated by Docusign Retrieve.
  This list should include all headers in the index file, exactly as they are spelled (case sensitive). Don't forget to comma-separate your field names.

  __sym_postfile__ : This is the file generated for posting RateReset changes to Symitar.

  * __filename__ : Name of the Symitar posing file to be generated

  * __header__ : Include header? (boolean) If set to true, the header will be based on the field names entered in the __postfile_fields__ list.

  * __postfile_fields__ : List of fields to be include in the posting file.  It should include enough information to communicate any required updates to the core required by the RateReset product offering.

__SynergyImportSettings__ : Manage all the settings required to generate a valid Synergy index file.

_The following fields are for using plain ftp to push files to a Synergy import directory. It is not a secure way to move information and it is strongly suggested not to use it. An better alternative would be to use exising automation tools to pick up and move any files._
* __ftp_files__ : move files via ftp? (boolean)
* __import_host__ : host where Synergy import directory resides
* __import_user__ : username to access Synergy import directory
* __import_pass__ : password
* __import_dir__ : path from ftp root to Synergy import directory

_the following define the synergy import details_
* __file_room__ : Synergy Fileroom

* __institution__ : Synergy institution number

* __deleteFiles__ : Should Synergy import process delete files after importing? (boolean)

* __cabinet__ : Synergy cabinet name

_What are you trying to pull here?_ Alright, so you may have started to notice some settings in the sample config file are  wrapped with double curley brackets. Remeber the __infile_fields__ discussed above? The values of the fields from the Retrieve index file can be referenced within the __SynergyImportSettings__ portion of the config file. The notation {{field_name}} will be substituted with the value of the field referenced. That also means that a literal value could also be used instead by simply omitting the double curly brackets. 

* __type__ : Synergy Document Type

* __docname__ : Synergy Document Name

* __indexes__ : list of Synergy Index Name and Index Value pairs

* __deleteFiles__ : directs Synergy's import process to delete files after they've been imported

* __cabinet__ : Synergy Cabinet

* __type__ : Synergy Document Type

* __docname__ : Synergy Document Name

* __filename__ : name of synergy index file. Usually best to default to "{{Envelope Id}}" so it specifies it's corresponding signed agreement document. 

* __indexes__ : This is a list of key-value pairs that build the index values for Synergy. This list can contain as many index values as are required to properly archive the document. It has the following structure..

  + __name__ : This is the name of the index element

  + __value__ : This is the value of the index element. This also uses the curley bracket notation. 
  
  
__Note__:
  It may be helpful to mention that multiple settings can be combined to create a single string...
```json
  {
    "name": "NAME",
    "value": "{{First Name}} {{Last Name}}"
  }
```
In the above example we can see how the index fields 'First Name' and 'Last Name' can be combined.


## Running

### Windows

```
  > [path_to_php_exe] [path_to_rate_reset_2020.php] --config=[path_to_config_file] [>> path_to_logging]
```

* __path_to_php_._exe__: Path to php.exe. If php.exe is already set in your $PATH environment var, then the full path is not required.

* __path_to_rate_reset_2020.php__ : This is the script 'rate_reset_2020.php' that is being executed.

* __path_to_config_file__: This is the config file that you just spent all that time setting up.

* __path_to_logging__ : Optional, output can be directed to a file or any other logging process your environment supports

___example:___

Something like this could be dropped into scheduled task on a Windows host

```
  C:\php\php.exe C:\ratereset\rate_reset_2020.php --config=c:\ratereset\auto\auto_config.json >> c:\ratereset\log\rate_reset.log
```

___note__: all paths can be absolute or relative to your present working directory (pwd)_

### *nix/MacOS

```
  $ [path_to_rate_reset_2020.php] --config=[path_to_config_file] [>> path_to_logging]
```

Unlike Windows, the php executable doesn't need to be call as part of the command. Just use CHMOD to make the 'rate_reset_2020.php' script executable and it will invoke the php runtime automatically. 

Alternatively, the php runtime can be specified in a *nix environment...

```
  $ php [path_to_rate_reset_2020.php] --config=[path_to_config_file] [>> path_to_logging]
```

Otherwise the other settings remain the same

___example:___

Something like this could be run manually or scheduled using cron.
```
  $ /home/ratereset/rate_reset_2020.php --config=/home/ratereset/auto/auto_config.json >>/home/ratereset/log/rate_reset.log
```

### Output

The result of this process should, at the very least, generate the following...

* __sym_postfile__ : the file to be processed in Symitar by a PowerOn.

* An xml formatted synergy index file for every corresponding pdf returned by Docusign Retrieve.

## Final Notes

### Purge

This script has a built in 'purge' function that will delete old files after a week. This is to keep old stuff from piling up over time.

