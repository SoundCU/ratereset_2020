# RATE RESET 2020

This program is designed to consume csv index files generated by Docusign Retrieve and, based on the information provided, generate the .csv file for a Symitar PowerOn and also Synergy formatted XML index files. 

This is a batch process that should be run daily. Typically we run it after branches close but scheduling should be whatever works best for your organization. 

## Requirements

### Any system capable of running PHP in 'CLI' mode. (No need to configure a web server. whew!)
 * To get the installer for windows use the link https://windows.php.net/download/
 * Mac or Linux, https://www.php.net/manual/en/install.php

_If you are feeling brave enough to tinker with PHP as a language, I strongly recommend https://www.php.net/manual/en/_

### A Place to Call Home
 * A directory to hold your data and run your scripts in. Here is the tree required. 
 
 _values wrapped in {{}} indicate it is a setting in the config file. (don't worry, we'll get there)_

A the directory tree should look something like this..
```
  - {{basedir}}        # basedir is the path where all RateReset automation takes place.
    - {{typedir}}      # typedir is the directory where RateReset files for the product type is held
    - archive          # archive is automatically generated by the script. 
```

### Product Type

Our solution is based on breaking down each RateReset offering into a separate type. What does this mean? 

Each type will have the following:
* a Docusign Retrieve sub-account. This will help prevent mixing of data accross product types
* a Docusign Retrieve generated index file
* a separate directory for processing RateReset files
* a separate config file adjusted to needs specific to the product type

### The Docusign Retrieve Index File

This is a CSV formatted file that is generated by Docusign Retrieve. 

This file should include all data that is required to perform both of the following functions:
* Any details specific to the document that would be required to file them in Synergy. 
* Any information required to peform required updates to the account in Symitar.

This file should always include a header row with the names of each field in the file. For example:

```
"Envelope Id","Payment","Interest Rate","Maturity Date","Amount Advanced","Payment Count","BorrowerFirstName","BorrowerLastName","SSN","Loan Number","Date of Last Modification","Loan Suffix","Cabinet","Type"
"6fce2137-ee37-4193-993f-a5d621ef3ece","$225.05","11.65","8/22/2025","$2,000.00","12","JEFF","LEWBOWSKI","","132134","2/25/2021","02","LOANS","LOANFLEX MODIFICATION AGREEMENT"
```

Wow..that's a lot.. we'll get back to how to deal with this in a moment


### The Config File

This is where all the magic happens. It is a json formatted file so there are some rules to editing these. _see https://www.json.org/json-en.html_

You'll need to create as separate config file for each product type. It is best practice to name each config file to match the product. For example, "auto_reset_config.json" would be the config for resetting auto loans. 


## Setup

### PHP 

_Windows_ There isn't an installer for PHP. It just downloads a zip file that expands into a directory of executables and supporting files. Find a place to you want to locate the PHP folder and then add that directory path to you $PATH environment variable.

_MacOS or Linux_ Both platforms have package managers available to handle this.

You'll know it's setup correctly when you can open a PowerShell or CMD prompt and do the following:
```
C:\Users\someuser>php --version
```

Output should be (dates and versions may vary):
```
PHP 7.4.15 (cli) (built: Feb  2 2021 20:47:36) ( NTS Visual C++ 2017 x64 )
Copyright (c) The PHP Group
Zend Engine v3.4.0, Copyright (c) Zend Technologies
```

### Docusign Retrieve

Probably should explain how this works. 

### Config Files

Ok, so this is what a config looks like...

```json

  "description": "home equity open end payment",
  "basedir": "/var/opt/shared/RateReset/",
  "typedir": "home_equity_openend",
  "docusign_infile": {
    "description": "file downloaded from docusign retrieve",
    "filename": "index.csv",
    "infile_fields": [
      "Envelope Id",
      "First Name",
      "Last Name",
      "SSN",
      "Account Number",
      "Loan ID",
      "New Due Date",
      "Deferral Request Months",
      "Deferral Requested Date",
      "Cabinet",
      "Type"
    ]
  },
  "sym_postfile": {
    "description": "fields to be included in Symitar datafile, must be from infile_fields",
    "filename": "RATERESET.HE.OE.DEFER.DAT",
    "header": false,
    "postfile_fields": [
      "Account Number",
      "Loan ID",
      "New Due Date",
      "Deferral Request Months",
      "Deferral Requested Date"
    ]
  },
  "SynergyImportSettings": {
    "description": "Synergy indexing fields can be fixed or pulled from infile_fields using template notation",
    "ftp_files": false,
    "import_host": "synergyhost",
    "import_user": "nobody",
    "import_pass": "password1",
    "import_dir": "/optical/import/dir",
    "file_room": "SomeCU",
    "institution": "999",
    "deleteFiles": true,
    "cabinet": "{{Cabinet}}",
    "type": "{{Type}}",
    "docname": "{{Type}}",
    "indexes": [
      {
        "name": "ACCOUNT NUMBER",
        "value": "{{Account Number}}"
      },
      {
        "name": "LOAN ID",
        "value": "{{Loan ID}}"
      },
      {
        "name": "NAME",
        "value": "{{First Name}} {{Last Name}}"
      },
      {
        "name": "TAX ID",
        "value": "{{SSN}}"
      },
      {
        "name": "DOC DATE",
        "value": "{{Deferral Requested Date}}"
      },
      {
        "name": "INDEX DATE",
        "value": "{{_today_}}"
      }
    ],
    "file": "{{Envelope Id}}"
  }
}
```

_Wait..what?_  Don't worry, I'll explain how this works. 